Ext.define("Valence.login.AppUmbrella",{extend:"Ext.app.Controller",requires:["Valence.common.util.Snackbar"],init:function(a){var b=this;Ext.apply(b,a);if(b.manageIframes){b.control({uxiframe:{load:b.onIframeLoad,beforedestroy:b.onIframeBeforeDestroy}})}b.listen({controller:{"*":{changeenvironment:b.onChangeEnvironment,changepassword:b.onChangePassword,lock:b.onLock,logout:b.onLogout,resumelock:b.onResumeLock,resumepolling:b.onResumePolling,suspendlock:b.onSuspendLock,suspendpolling:b.onSuspendPolling}},component:{"component[basePortal]":{render:b.onRenderBasePortalComponent}}});b.settings=Valence.login.config.Settings;b.runtime=Valence.login.config.Runtime},initTasks:function(){var a=this;if(a.poll){a.pollRunner=Ext.TaskManager.start({scope:a,run:a.pollServer,interval:a.settings.getPollInterval()})}if(a.autoLock){if(a.settings.getLockTimeout()!==0){a.lockTask=new Ext.util.DelayedTask(a.onLock,a);a.lockTask.delay(a.settings.getLockTimeout())}}if(a.autoLogout){if(a.settings.getSessionTimeout()!==0){a.logoutTask=new Ext.util.DelayedTask(a.sessionTimeout,a);a.logoutTask.delay(a.settings.getSessionTimeout())}}},onAttemptUnlockSuccess:function(r){var me=this,lock=Ext.ComponentQuery.query("lock")[0],d=Ext.decode(r.responseText);if(d.success){lock.destroy();me.runtime.setIsLocked(false);if(!Ext.isEmpty(me.lockTask)){me.lockTask.delay(me.settings.getLockTimeout())}}else{pw.markInvalid(eval(d.lit).replace("VAR1",d.var1))}},onChangeEnvironment:function(){var a=this,b=Valence.login.config.Runtime.getApplication();if(Valence.login.config.Runtime.getIsDesktop()){Ext.widget("changeenvironment",{closeAppsMsg:a.settings.getCloseAppsOnEnvironmentChange(),listeners:{scope:a,destroy:a.onDestroyChangeEnvironment,itemclick:a.onItemclickEnvironment}}).show();if(b){b.fireEvent("showchangeenvironment")}}},onChangePassword:function(b){var a=this,c=Valence.login.config.Runtime.getApplication();if(c&&c.fireEvent("beforeshowchangepassword")!==false){Ext.widget("changepassword",{animateTarget:b||null,viewModel:{data:{user:a.runtime.getUser()}}})}},onDestroyChangeEnvironment:function(){var a=this,b=Valence.login.config.Runtime.getApplication();if(b){b.fireEvent("hidechangeenvironment")}},onIframeBeforeDestroy:function(c){var b=c.getDoc(),a=(b)?b.getElementsByName("session")[0]:null;if(!Ext.isEmpty(a)){Ext.Ajax.request({url:"/webaccess/iWAActiveSessions?action=stop&session="+a.getAttribute("value")})}},onIframeLoad:function(c){var a=this,b=c.getDoc();if(b){if(Ext.isIE8){b.attachEvent("click",Ext.bind(a.resetTimers,a))}else{b.addEventListener("click",Ext.bind(a.resetTimers,a))}}},onItemclickEnvironment:function(h,b){var g=this,c=g.settings.getCloseAppsOnEnvironmentChange(),d=b.get("current"),e=h.getStore(),a=Valence.login.config.Runtime.getApplication(),f={text:Valence.lang.lit.yourEnvChanged},i;if(!d&&a&&a.fireEvent("beforeenvironmentset",g.runtime.getUser(),b.get("envId"))!==false){Ext.ComponentQuery.query("changeenvironment")[0].el.mask(Valence.lang.lit.settingEnvironment);Ext.Ajax.request({omitPortalCredentials:true,url:"/valence/vvlogin.pgm",params:{action:"setEnvironment",sid:Valence.util.Helper.getSid(),env:b.get("envId")},scope:g,success:function(j){var k=Ext.decode(j.responseText);Ext.ComponentQuery.query("changeenvironment")[0].el.unmask();if(k.success){if(Valence.login.config.Runtime.getIsDesktop()){sessionStorage.setItem("env",b.get("envId"))}e.findRecord("current",true).set("current",false);b.set("current",true);e.commitChanges();g.runtime.setLoginData(Ext.apply(g.runtime.getLoginData(),{env:b.get("envId")}));if(a){a.fireEvent("logindataupdated",g.runtime.getLoginData())}if(c){i=Portal.util.Helper.getActiveAppIds();if(i.length>0){Ext.apply(f,{buttonText:Valence.lang.lit.relaunchApps,duration:8000,handler:function(){for(var l=0;l<i.length;l++){Portal.util.Helper.launchApp(i[l])}}})}Portal.util.Helper.closeAllApps()}Ext.ComponentQuery.query("changeenvironment")[0].destroy();Valence.common.util.Snackbar.show(f);if(a){a.fireEvent("environmentset",g.runtime.getUser(),b.get("envId"))}}else{Valence.common.util.Snackbar.show(Valence.lang.lit.environmentNotSet)}}})}},onLock:function(){var a=this,b=Valence.login.config.Runtime.getApplication();a.onSuspendLock();if(!a.runtime.getIsLocked()){if(b){if(b.fireEvent("beforelock")===false){return}}Ext.Ajax.request({url:a.hostUrl+"/valence/vvlogin.pgm",params:{action:"lock"},scope:a,success:a.onLockSuccess})}},onLockSuccess:function(b){var a=this,e=Ext.decode(b.responseText),c=Valence.login.config.Runtime.getApplication();if(e.success){a.runtime.setIsLocked(true);if(c){c.fireEvent("locked")}Valence.login.Processor.processLock()}},onLogout:function(){var j=this,i=Ext.ComponentQuery.query("uxiframe[app]"),g=j.runtime.getUser(),k={action:"logout"},b=Valence.login.config.Runtime.getApplication(),m=Ext.bind(function(){var e=Ext.bind(j.processLogout,j),o;if(localStorage.getItem("sid")===j.runtime.getLoginData().sid){localStorage.removeItem("sid")}if(Valence.login.config.Runtime.getIsDesktop()){sessionStorage.removeItem("env")}if(b){console.log("loggedout");b.fireEvent("loggedout",g)}console.log("logout");Ext.Function.defer(function(){o={duration:100,easing:"easeOut",opacity:0.15,callback:function(){e()}};if(Ext.isClassic){Ext.get(document.body).fadeOut(o)}else{Ext.get(document.body).animate(o)}},150)},j),f;if(j.runtime.getIsLoggingOut()||(b&&b.fireEvent("beforelogout",g,k)===false)){return}j.runtime.setIsLoggingOut(true);if(Valence.login.Processor.getNamespace()==="Portal"){if(Valence.login.config.Runtime.getIsDesktop()){var n=Ext.getStore("RunningApps"),a=[];n.each(function(e){a.push(e.get("appId"))});sessionStorage.setItem("valence-last-running-apps",a)}for(var l=0;l<i.length;l++){i[l].destroy()}var d=j.runtime.getActiveWindows();if(d){for(l=0;l<d.length;l++){try{d[l].close()}catch(c){}}}if(Ext.isModern){Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading,zIndex:1000})}}j.runtime.setActiveWindows([]);j.onSuspendPolling();try{Ext.Ajax.request({url:j.hostUrl+"/valence/vvvport.pgm",params:k,scope:j,async:false,success:m,failure:m})}catch(h){m()}},onRenderBasePortalComponent:function(b){var a=this,c=Valence.login.config.Runtime.getApplication();if(c){c.fireEvent("componentrender",b)}},pollServer:function(){var b=this,a=b.runtime.getLogoutTaskReset(),d=Valence.login.config.Runtime.getApplication(),c={action:"poll",timerReset:a};if(a){b.runtime.setLogoutTaskReset(false)}if(d){d.fireEvent("beforepoll",c)}Ext.Ajax.request({url:b.hostUrl+"/valence/vvvport.pgm",params:c,scope:b,success:b.pollServerSuccess,failure:function(e){if(e.status!==569){b.runtime.setIsConnected(false)}}})},pollServerSuccess:function(b){var a=this,f=Ext.decode(b.responseText),e=Valence.login.config.Runtime.getApplication();if(e){e.fireEvent("poll",f)}switch(f.status){case"ok":a.runtime.setIsConnected(true);break;case"*NOSESSION":if(!Ext.isEmpty(a.lockTask)){a.lockTask.cancel()}if(!a.runtime.getIsLoggingOut()){Valence.common.util.Dialog.show({title:Valence.lang.msg.sessionEndHeader,msg:Valence.lang.msg.sessionEndBody,buttons:["->",{text:Valence.lang.lit.ok}],scope:a,handler:a.onLogout})}break;case"RELOAD":var c=Ext.getStore("Apps");if(c){c.load()}break}},processLogout:function(){var d=Ext.getUrlParam(),a=["password","customSid"],c=function(f,e){if(!Ext.isEmpty(b)){b+="&"}b+=f+"="+e},b="";if(!Ext.Object.isEmpty(d)){Ext.iterate(d,function(f,e){if(Ext.Array.indexOf(a,f)===-1){c(f,e)}})}location.search=b},resetTimers:function(){var a=this;if(!Ext.isEmpty(a.lockTask)){a.lockTask.delay(a.settings.getLockTimeout())}if(a.logoutTask){a.runtime.setLogoutTaskReset(true);a.logoutTask.delay(a.settings.getSessionTimeout())}},onResumeLock:function(){var a=this;if(!Ext.isEmpty(a.lockTask)){a.lockTask.delay(a.settings.getLockTimeout())}},onResumePolling:function(){var a=this;if(a.pollRunner){Ext.TaskManager.start(a.pollRunner)}},sessionTimeout:function(){var a=this;a.onLogout()},onSuspendLock:function(){var a=this;if(!Ext.isEmpty(a.lockTask)){a.lockTask.cancel()}},onSuspendPolling:function(){var a=this;if(a.pollRunner){Ext.TaskManager.stop(a.pollRunner)}}});Ext.define("Valence.login.config.Runtime",{singleton:true,config:{activeWindows:[],allowChangePassword:false,appContainer:"canvas",autoLogin:false,environment:null,language:null,isConnected:null,isMobile:false,isDesktop:false,isLocked:false,isLoggingOut:false,logoutTaskReset:false,loginData:null,reloadApps:false,namespace:null,theme:null,urlParms:Ext.getUrlParam(),user:null},constructor:function(){this.initConfig(this.config)},applyAppContainer:function(a){var b=this;if(b.getUrlParms().tabbed){return"canvastabs"}else{return(a=="1")?"canvastabs":"canvas"}},applyIsConnected:function(b){var c=this,a;if(b===false){if(Ext.isClassic){Ext.MessageBox.wait(Valence.lang.lit.reconnectBody,'<p style="font-size:11pt";>'+Valence.lang.lit.reconnectHeader+"</p>")}else{Valence.login.config.Runtime.getApplication().fireEvent("disconnected");Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.reconnectBody,zIndex:1000})}}else{if(b===true){if(!c.getIsConnected()){if(Ext.isClassic&&Ext.Msg.isVisible()){Ext.Msg.hide()}else{if(Ext.isModern){a=Ext.Viewport.getMasked();if(!Ext.isEmpty(a)||a){Valence.login.config.Runtime.getApplication().fireEvent("connected");Ext.Viewport.unmask()}}}}}}return b},applyLoginData:function(d){var b=this,c;if(!d){return}d.envName="???";if(!Ext.isEmpty(d.loginId)){d.loginId=Ext.util.Format.uppercase(d.loginId);d.initial=d.loginId.substr(0,1)}else{d.loginId="???";d.initial=d.loginId.substr(0,1)||"?"}if(!Ext.isEmpty(d.firstname&&!Ext.isEmpty(d.lastname))){d.initial=d.firstname.substr(0,1)+d.lastname.substr(0,1)}if(!Ext.isEmpty(d.envs)){d.alwChgEnv=(d.envs.length>1);if(!Ext.isEmpty(d.env)){for(var a=0;a<d.envs.length;a++){c=d.envs[a];if(d.env==c.envId){d.envName=Valence.util.Helper.decodeUTF16(c.envName)}}}}else{d.alwChgEnv=false}if(!Ext.isEmpty(d.theme)){b.setTheme(d.theme)}if(!Ext.isEmpty(d.layout)){b.setAppContainer(d.layout)}return d},getApplication:function(){var b=this,a=b.getNamespace();if(a&&!Ext.isEmpty(window[a])&&typeof window[a].getApplication==="function"){return window[a].getApplication()}return null}});Ext.define("Valence.login.config.Settings",{singleton:true,config:{aboutPage:"/desktop/about/index.html",browserTitle:"Valence",closeAppsOnEnvironmentChange:true,dateFormat:"Y-m-d",defaultLanguage:"en",displayLaunchpad:true,favicon:"/resources/images/favicon.ico",iconOnTab:true,lockTimeout:120,lockConnections:false,logoutOnUnload:false,maxAutoStartApps:null,maxAppsOpen:15,maxFavorites:24,menuTextMode:"USER",multiLingual:null,pathVariables:null,passwordReset:null,pollInterval:30,promptBeforeCloseMsg:null,promptBeforeCloseTitle:null,sessionTimeoutWarning:null,sessionTimeout:null,setUserCookie:null,tabShortcutKeys:true,version:null,welcomePage:null,zoom5250:1.5},applyLockTimeout:function(a){return a*60000},applyPollInterval:function(a){return a*1000},applySessionTimeout:function(a){var d=this,b=a,c=(b>2)?(b-(b-2)):null;if(c){d.setSessionTimeoutWarning(c*60000)}return a*60000},constructor:function(){this.initConfig(this.config)}});Ext.define("Valence.login.model.Language",{extend:"Ext.data.Model",fields:[{name:"VVLNGNAME",type:"string",convert:Valence.util.Helper.decodeUTF16},{name:"VVLNG",type:"string"}],proxy:{type:"ajax",url:"",extraParams:{action:"getLanguages"},reader:{type:"json",rootProperty:"VVLNGS"}}});Ext.define("Valence.login.store.Languages",{extend:"Ext.data.Store",requires:["Valence.login.model.Language"],storeId:"Languages",model:"Valence.login.model.Language"});Ext.define("Valence.login.util.Helper",{singleton:true,requires:["Valence.common.util.Dialog"],getHookValue:function(f){var c=Valence.Hook,e=f.split("."),d=localStorage.getItem("valence-theme"),b=c[e[0]];if(b){for(var a=1;a<e.length;a++){if(!Ext.isEmpty(b)){b=b[e[a]]}else{Ext.log({msg:"Property "+f+" not found in Valence.Hook"});return null}}if(b){if(!Ext.isEmpty(b[d])){b=b[d]}else{b=b["default"]}}}return b},showImageDialog:function(d,e){var c=this,b="";if(!Ext.isEmpty(e)){var a=(Valence.login.config.Runtime.getIsDesktop())?"max-width: 200px;":"";b='<div style="text-align: center;"><img src="'+e+'" cls="vv-login-img" style="'+a+'"></img></div>'}b+='<div style="margin-top:16px;">'+d+"</div>";Valence.common.util.Dialog.show({msg:b,minHeight:140,noButtons:true})}});Ext.define("Valence.login.model.Connection",{extend:"Ext.data.Model",requires:["Ext.data.proxy.LocalStorage"],fields:[{name:"desc",defaultValue:""},{name:"url",defaultValue:""},{name:"port",defaultValue:""},{name:"autostartappid",defaultValue:""},{name:"invalid",type:"boolean",defaultValue:false},{name:"selected",type:"boolean",defaultValue:false},{name:"lastLoggedInUser",type:"string",defaultValue:""}],proxy:{autoLoad:false,autoSync:true,type:"localstorage",id:"valence-connections"}});Ext.define("Valence.login.store.Connections",{extend:"Ext.data.Store",requires:["Valence.login.model.Connection"],storeId:"Connections",model:"Valence.login.model.Connection"});Ext.define("Valence.login.model.Environment",{extend:"Ext.data.Model",fields:["envId","current",{name:"envName",convert:Valence.util.Helper.decodeUTF16}],proxy:{type:"memory",reader:{type:"json"}}});Ext.define("Valence.login.store.Login_Environments",{extend:"Ext.data.Store",requires:["Valence.login.model.Environment"],storeId:"Login_Environments",model:"Valence.login.model.Environment"});Ext.define("Valence.login.view.login.LoginModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.login",data:{appBarTitleIconAlign:"left",appBarTitleIconCls:"x-fa fa-bars",appBarTitleHide:false,appBarTitleMenuHide:true,appBarUI:"primary-dark",appBarSearch:false,appBarSearchIcon:false,connectionsCls:"",forgotPasswordCls:"vv-login-forgot-pwd",forgotPasswordPrompt:false,hasConnection:false,inConnectionEditMode:false,loginValidation:true,loginValidationText:Valence.lang.lit.canNotBeBlank,loginDisabled:false,mobilePortal:false},formulas:{connectionRequired:function(a){return Valence.login.Processor.isPortal()&&a("mode")!=="desktop"&&(Ext.os.name=="iOS"||Ext.os.name=="Android")},showNoConnection:function(a){return a("connectionRequired")&&!a("hasConnection")},showExistingConnection:function(a){return a("connectionRequired")&&a("hasConnection")},connectionsCls:function(a){return(a("hasConnection")?"vv-login-connections":"vv-login-connections vv-login-connections-none")},loginValidationHTML:function(a){return(a("loginValidation")?"":a("loginValidationText"))},editConnectionBtnIconCls:function(a){return(a("inConnectionEditMode")?"vvicon vvicon-pencil6":"")},connectionFtrEditIconCls:function(a){return(a("inConnectionEditMode")?"fa fa-times":"vvicon vvicon-pencil6")}}});Ext.define("Valence.login.view.changepassword.ChangepasswordController",{extend:"Ext.app.ViewController",alias:"controller.changepassword",onClickOk:function(){var g=this,b=g.getViewModel(),h=g.getView(),a=h.lookupReference("curpwd").getValue(),f=h.lookupReference("newpwd").getValue(),i=h.lookupReference("newpwd2").getValue(),e=b.get("user"),d={user:Valence.util.Helper.encodeUTF16(e),action:"chgPassword",curpwd:Valence.util.Helper.encodeUTF16(a),newpwd:Valence.util.Helper.encodeUTF16(f),newpwd2:Valence.util.Helper.encodeUTF16(i)},c=Valence.login.config.Runtime.getApplication();if(c&&c.fireEvent("beforechangepassword",d)!==false){if(Ext.isClassic){h.el.mask()}else{Ext.Viewport.mask({xtype:"loadmask"})}Ext.Ajax.request({url:Valence.login.Processor.getHostUrl()+"/valence/vvlogin.pgm",params:d,success:function(j){if(Ext.isClassic){h.el.unmask()}else{Ext.Viewport.unmask()}var k=Ext.decode(j.responseText);if(k.success){if(c){c.fireEvent("passwordchanged",e,f)}g.fireViewEvent("success",f);h.destroy();if(Ext.isClassic){Valence.common.util.Snackbar.show(Valence.lang.lit.passwordChg)}}else{h.lookupReference(k.fld).markInvalid(Valence.common.util.Helper.getLit(k))}}})}},onClickCancel:function(){var a=Valence.login.config.Runtime.getApplication();if(a){a.fireEvent("passwordcancel")}this.getView().close()},onSpecialKeyPassword:function(b,f){var d=this,a=d.getView(),c=a.lookupReference("form");if(f.getKey()===f.ENTER&&c.isValid()){d.onClickOk()}}});Ext.define("Valence.login.view.changepassword.ChangepasswordModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.changepassword"});Ext.define("Valence.login.view.changepassword.Changepassword",{extend:"Ext.Window",requires:["Ext.button.Button","Ext.form.field.Text","Ext.form.Panel","Ext.layout.container.Fit","Valence.login.view.changepassword.ChangepasswordController","Valence.login.view.changepassword.ChangepasswordModel"],xtype:"changepassword",basePortal:true,cls:"vv-chg-pwd",autoShow:true,viewModel:{type:"changepassword"},controller:"changepassword",layout:"fit",width:400,modal:true,title:Valence.lang.lit.changePassword,defaultFocus:"[name=curpwd]",buttons:[{text:Valence.lang.lit.cancel,handler:"onClickCancel"}],items:[{xtype:"form",reference:"form",cls:"vv-chg-pwd-form",bodyPadding:"8 24",defaults:{xtype:"textfield",allowBlank:false,inputType:"password",labelAlign:"top",labelSeparator:"",anchor:"100%",msgTarget:"under"},items:[{reference:"curpwd",fieldLabel:Valence.lang.lit.currentPassword,cls:"vv-chgpwd-cur",labelClsExtra:"vv-chgpwd-cur-lbl",name:"curpwd",listeners:{specialkey:"onSpecialKeyPassword"}},{reference:"newpwd",fieldLabel:Valence.lang.lit.newPassword,cls:"vv-chgpwd-new",labelClsExtra:"vv-chgpwd-new-lbl",name:"newpwd",listeners:{specialkey:"onSpecialKeyPassword"}},{reference:"newpwd2",fieldLabel:Valence.lang.lit.retypeNewPassword,cls:"vv-chgpwd-new2",labelClsExtra:"vv-chgpwd-new2-lbl",name:"newpwd2",listeners:{specialkey:"onSpecialKeyPassword"}},{xtype:"button",formBind:true,cls:"vv-chgpwd-ok-btn",text:Valence.lang.lit.ok,scale:"medium",handler:"onClickOk"}]}]});Ext.define("Valence.login.view.login.LoginController",{extend:"Ext.app.ViewController",alias:"controller.login",requires:["Valence.common.util.Dialog","Valence.login.view.changepassword.Changepassword","Valence.login.store.Connections","Valence.common.util.Snackbar","Valence.login.util.Helper"],init:function(){var a=this;a.listen({global:{vvonline:"onNetworkChangeOnline",vvoffline:"onNetworkChangeOffline"}})},initViewModel:function(d){var e=this,a=e.getView(),c,f,b;d.set({forgotPasswordText:Valence.lang.lit.forgotPassword,connectionsText:Valence.lang.lit.noConnections});if(Ext.isModern){d.bind("{loginValidation}",function(g){Ext.each(a.query("field"),function(h){if(/field/.test(h.getXTypes())){h.toggleCls("vv-field-invalid",!g)}return true})})}},afterRender:function(d){var c=this,a=d.lookupReference("user"),b=d.lookupReference("password");setTimeout(function(){var e,f;if(!Ext.isEmpty(a)){e=a.getValue()}if(!Ext.isEmpty(b)){f=b.getValue()}if(a&&Ext.isEmpty(e)){a.focus()}else{b.focus()}if(!Ext.isEmpty(e)&&!Ext.isEmpty(f)){c.onLogin()}},200)},onAfterRenderLogin:function(){var d=this,c=d.getViewModel(),b,f,a,e;if(c.get("connectionRequired")){a=d.getConnectionStore();e=function(g){if(g.get("selected")&&g.get("invalid")){return true}return false};f=a.getAt(a.findBy(e));if(!Ext.isEmpty(f)){c.set({hasConnection:false,connectionsText:f.get("desc")+" !",loginDisabled:true});Valence.common.util.Dialog.show({title:Valence.lang.lit.invalidConnection,msg:"Cannot connect to "+f.get("desc"),buttons:["->",{text:Valence.lang.lit.ok}],handler:function(){d.connectionHandler(false)}});return}f=a.findRecord("selected",true);if(a.getCount()>0){if(Ext.isEmpty(f)){f=a.getAt(0);f.set("selected",true);f.commit();a.sync()}b={hasConnection:true,connectionsText:f.get("desc"),hostUrl:f.get("url")+":"+f.get("port")};Ext.apply(b,f.getData())}else{b={hasConnection:false,loginDisabled:true,connectionsText:Valence.lang.lit.noConnections}}c.set(b);setTimeout(function(){Ext.Viewport.unmask()},300)}},getConnectionStore:function(){var a=Ext.getStore("Connections");if(Ext.isEmpty(a)){a=Ext.create("Valence.login.store.Connections")}return a},onClickConnectionMenuAdd:function(){var b=this,a=b.getViewModel();a.set("inConnectionEditMode",false);b.connectionHandler(true)},onClickConnectionMenuBtn:function(c){var e=this,d=e.getViewModel(),g=c.rec,b=g.get("desc"),a=g.get("url")+":"+g.get("port"),f=Valence.login.Processor.getOptions();Valence.login.Processor.setOptions(Ext.apply(f,{hostUrl:a}));Valence.login.Processor.setHostUrl(a);if(d.get("inConnectionEditMode")){if(!Ext.isEmpty(g)){d.set({connRec:g})}e.connectionHandler(true);return}d.set({hasConnection:true,loginDisabled:false,connectionsText:b});Ext.Viewport.hideMenu("left")},onClickConnectionMenuEdit:function(){var b=this,a=b.getViewModel();a.set("inConnectionEditMode",!a.get("inConnectionEditMode"))},onClickCancelForgotPassword:function(){var b=this,a=b.getViewModel();a.set({forgotPasswordPrompt:false,forgotPasswordText:Valence.lang.lit.forgotPassword,loginValidation:true})},connectionHandler:function(e){var f=this,g=f.getView(),c=f.getViewModel(),j={xtype:"container",docked:"bottom",layout:{type:"hbox"},defaults:{height:40,ui:"transparent",flex:1},items:[{xtype:"button",bind:{iconCls:"{connectionFtrEditIconCls}"},listeners:{tap:"onClickConnectionMenuEdit",scope:f}},{xtype:"button",iconCls:"fa fa-plus",listeners:{tap:"onClickConnectionMenuAdd",scope:f}}]},d={xtype:"component",cls:"vv-connections-menu-hdr",html:Valence.lang.lit.connections},k,b,i=[],h,a,l;k=Ext.getStore("Connections");if(k.getCount()==0||e){if(e){Ext.Viewport.hideMenu("left")}g.setActiveItem(1)}else{k.each(function(m){h=m.get("desc");if(m.get("invalid")){h+='<span style="padding-left:8px; position:relative; top:1px;" class="vvicon vvicon-notification2"></span>'}i.push({text:h,rec:m,bind:{iconCls:"{editConnectionBtnIconCls}"}})});a=[d,{xtype:"container",cls:"vv-connections-menu-body",defaultType:"button",defaults:{ui:"transparent",listeners:{tap:"onClickConnectionMenuBtn",scope:f},cls:"vv-connections-menu-body-btn",iconAlign:"right"},items:i}];l=Valence.login.config.Settings.getLockConnections();if(Ext.isString(l)){l=(l=="true")}if(!l){a.push(j)}b=Ext.create("Ext.Menu",{cls:"vv-login-connections-menu",viewModel:c,listeners:{hide:"onHideConnectionMenu",scope:f},items:a});Ext.Viewport.setMenu(b,{side:"left",cover:false});Ext.Viewport.showMenu("left")}},onClickConnection:function(){var a=this;a.connectionHandler()},onClickForgotPassword:function(){var b=this,a=b.getViewModel();a.set({forgotPasswordPrompt:true,forgotPasswordText:Valence.lang.lit.tempPasswordPrompt,loginValidation:true})},onClickSelectLanguage:function(){var c=this,a,b;if(Ext.isClassic){a=c.getView();a.el.down(".x-box-inner").addCls("vv-login-show-select-lng");Ext.widget("window",{title:Valence.lang.lit.selectLanguage,layout:"fit",autoShow:true,width:300,modal:true,closable:true,items:[{xtype:"grid",store:"Languages",hideHeaders:true,columns:[{flex:1,text:Valence.lang.lit.language,dataIndex:"VVLNGNAME"}],listeners:{scope:c,itemclick:"onSelectLanguage"}}],listeners:{scope:c,destroy:"onDestroyLanguageSelection"}})}else{Valence.common.util.PickerList.showPickerList({title:"Select a Language:",handler:c.onSelectLanguage,listArray:"Languages",displayField:"VVLNGNAME",scope:c})}},onDestroyChangepassword:function(c){var b=this,a=b.getView();a.el.down(".x-box-inner").removeCls("vv-login-show-chg-password")},onDestroyLanguageSelection:function(c){var b=this,a=b.getView();a.el.down(".x-box-inner").removeCls("vv-login-show-select-lng")},onHideConnectionMenu:function(){var c=this,a=c.getView(),b=c.getViewModel();if(/login/.test(a.getActiveItem().getXTypes())){b.set("inConnectionEditMode",false)}},onLogin:function(){var l=this,c=l.getViewModel(),m=l.getView(),b=m.lookupReference("form"),o=b.getValues(),i=o.user,p=Valence.login.Processor.getAppId(),e=Valence.login.config.Runtime.getApplication(),h=Valence.login.Processor.getHostUrl(),g=Valence.login.Processor.getNamespace()=="Portal"&&Ext.isModern&&(Ext.os.name=="iOS"||Ext.os.name=="Android"),a,n={action:"login",lng:c.get("language"),display:c.get("mode"),version:c.get("version"),forceEnv:Valence.login.config.Runtime.getUrlParms().environment},k,d,j,f;if(Ext.isModern){if(Ext.isEmpty(o.user)){m.lookupReference("user").toggleCls("vv-field-invalid",true);c.set("loginValidation",false);k=true}else{m.lookupReference("user").toggleCls("vv-field-invalid",false)}if(Ext.isEmpty(o.password)){m.lookupReference("password").toggleCls("vv-field-invalid",true);c.set("loginValidation",false);k=true}else{m.lookupReference("password").toggleCls("vv-field-invalid",false)}if(k){c.set("loginValidationText",Valence.lang.lit.canNotBeBlank);return}}o.user=Valence.util.Helper.encodeUTF16(o.user);o.password=Valence.util.Helper.encodeUTF16(o.password);Ext.apply(n,o);if(!Ext.isEmpty(p)){Ext.apply(n,{validateAppId:p})}if(g){Valence.login.Processor.setHostUrl(h)}else{if(Ext.isModern){Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading})}else{Valence.common.util.Helper.loadMask(Valence.lang.lit.validatingLogin)}}if(!e||e.fireEvent("beforelogin",n)!==false){a=h+"/valence/vvlogin.pgm";Ext.Ajax.request({url:a,params:n,scope:l,success:function(q){Valence.common.util.Helper.destroyLoadMask();var v=Ext.decode(q.responseText);if(g){Ext.Viewport.unmask()}else{Valence.common.util.Helper.destroyLoadMask()}if(v.success){localStorage.setItem("sid",v.sid);sessionStorage.setItem("sid",v.sid);if(Valence.login.config.Runtime.getIsDesktop()){sessionStorage.setItem("env",v.env)}Ext.create("Valence.login.store.Login_Environments",{data:v.envs});Valence.login.config.Runtime.setUser(i);if(e){e.fireEvent("login",i,v.sid);e.fireEvent("environmentset",i,v.env)}v.firstname=Valence.util.Helper.decodeUTF16(v.firstname);v.lastname=Valence.util.Helper.decodeUTF16(v.lastname);if(Ext.isModern&&Valence.login.Processor.isPortal()){d=l.getConnectionStore();j=function(r){return r.get("selected")&&r.get("invalid")};f=d.getAt(d.findBy(j));if(!Ext.isEmpty(f)){f.set("invalid",false);f.commit();d.sync()}}l.fireViewEvent("loggedin",l.getView(),Ext.apply(v,{loginId:i}))}else{if(e){e.fireEvent("loginfailure",n,v)}var t=v.sts||null;if(!t){if(Ext.isEmpty(v.fld)&&!Ext.isEmpty(v.lit)){var s=m.down("image"),u=(!Ext.isEmpty(s)&&!Ext.isEmpty(s.src))?s.src:null;Valence.login.util.Helper.showImageDialog(Valence.common.util.Helper.getLit(v),u);m.hide()}else{if(Ext.isClassic){m.lookupReference(v.fld).markInvalid(Valence.common.util.Helper.getLit(v))}else{m.lookupReference(v.fld).toggleCls("vv-field-invalid",true);c.set({loginValidation:false,loginValidationText:Valence.lang.lit.invalidLogin.toLowerCase()})}}}else{if(t==="changepassword"){if(e&&e.fireEvent("beforeshowchangepassword")!==false){if(Valence.login.config.Runtime.getIsDesktop()){m.el.down(".x-box-inner").addCls("vv-login-show-chg-password");Ext.widget("changepassword",{listeners:{scope:l,destroy:"onDestroyChangepassword",success:"onSuccessChangepassword"},viewModel:{data:{user:m.lookupReference("user").getValue()}}})}}}else{if(t==="killsession"||t==="exceededlimit"){if(Valence.login.config.Runtime.getIsDesktop()){Valence.common.util.Dialog.show({msg:Valence.common.util.Helper.getLit(v),buttons:[{text:Valence.lang.lit.ok}]})}else{}}else{Valence.common.util.Snackbar.show(Valence.lang.lit.serverError)}}}}if(Ext.isModern){Ext.Viewport.unmask()}},failure:function(){Ext.log({msg:"login failure"});if(Ext.isModern){Ext.Viewport.unmask()}else{Valence.common.util.Helper.destroyLoadMask()}Valence.common.util.Dialog.show({title:Valence.lang.lit.error,msg:Valence.lang.lit.noResponseFromServer,buttonAlign:"right",buttons:[{text:Valence.lang.lit.ok}]})}})}},onKeyupLogin:function(c,g){var d=this,a=d.getView(),b,f;if(g.keyCode==13){b=c.getName();if(b=="user"){f=a.lookupReference("password");f.focus()}else{if(b=="password"){d.onLogin()}}}},onNetworkChangeOnline:function(){if(Ext.os.name=="iOS"||Ext.os.name=="Android"){var c=this,b=false,a=Ext.getStore("Connections");if(Ext.isEmpty(a)||a.getCount()==0){b=true}c.getViewModel().set("loginDisabled",b)}},onNetworkChangeOffline:function(){if(Ext.os.name=="iOS"||Ext.os.name=="Android"){var a=this;a.getViewModel().set("loginDisabled",true)}},onRenderLogin:function(a){a.getLayout().onContentChange()},onSelectLanguage:function(a,f){var d=this,b=f.get("VVLNG");if(Valence.login.config.Runtime.getIsDesktop()){var e=window.location,c=e.pathname+"?lang="+b;if(Ext.isModern){c+="&modern"}e.href=c}else{}},onSendPassword:function(){var g=this,e=g.getViewModel(),a=g.getView(),f=a.lookupReference("form"),c=f.getValues(),b=c.user,h=Valence.login.config.Runtime.getApplication(),d={action:"sendPassword",user:Valence.util.Helper.encodeUTF16(b),text0:Valence.util.Helper.encodeUTF16(Valence.lang.lit.tempPassword),text1:Valence.util.Helper.encodeUTF16(Valence.lang.lit.tempPasswordEmail1),text2:Valence.util.Helper.encodeUTF16(Valence.lang.lit.tempPasswordEmail2),text3:Valence.util.Helper.encodeUTF16(Valence.lang.lit.tempPasswordEmail3)};if(Ext.isEmpty(b)){if(Ext.isModern){a.lookupReference("user").toggleCls("vv-field-invalid",true);e.set("loginValidation",false)}return}if(h&&h.fireEvent("beforesendpassword",d)!==false){f.el.mask();Ext.Ajax.request({url:Valence.login.Processor.getHostUrl()+"/valence/vvlogin.pgm",params:d,scope:g,success:g.onSendPasswordSuccess})}},onSendPasswordSuccess:function(e){var c=this,f=Ext.decode(e.responseText),b=c.getView().lookupReference("form");b.el.unmask();if(f.success){c.onClickCancelForgotPassword();Valence.common.util.Snackbar.show(Valence.lang.lit.tempPasswordSent)}else{var a=c.getView().lookupReference(f.fld);if(a){a.markInvalid(Valence.common.util.Helper.getLit(f));a.focus()}}},onSpecialKeyPassword:function(b,f){var d=this,a=d.getView(),c=a.lookupReference("form");if(f.getKey()===f.ENTER&&c.isValid()){if(a.getXType()==="login"){d.onLogin()}else{d.onUnlock()}}},onSuccessChangepassword:function(a,d){var c=this,b=c.getView().lookupReference("password");b.setValue(d);c.onLogin()},onUnlock:function(){var d=this,c=d.getViewModel(),a=d.getView(),b=a.lookupReference("password").getValue();Ext.Ajax.request({url:c.get("hostUrl")+"/valence/vvlogin.pgm",params:{action:"unlock",password:Valence.util.Helper.encodeUTF16(b)},scope:d,success:d.onUnlockSuccess})},onUnlockSuccess:function(c){var b=this,a=b.getView(),f=Valence.login.config.Runtime.getApplication(),e=Ext.decode(c.responseText);if(e.success){a.el.fadeOut({callback:function(){a.destroy()}});Valence.login.config.Runtime.setIsLocked(false);if(f){f.fireEvent("unlock");f.fireEvent("resumelock")}}else{a.lookupReference("password").markInvalid(Valence.common.util.Helper.getLit(e))}}});Ext.define("Valence.login.view.login.Login",{extend:"Ext.container.Container",requires:["Ext.button.Button","Ext.form.field.Text","Ext.form.Panel","Ext.layout.container.VBox","Valence.login.view.login.LoginModel","Valence.login.view.login.LoginController"],xtype:"login",viewModel:{type:"login"},controller:"login",cls:"vv-login-cnt",layout:{type:"vbox",align:"middle"},basePortal:true,initComponent:function(){var a=this;Ext.apply(a,{items:a.buildItems()});a.callParent(arguments);a.on({scope:a,afterrender:a.onAfterRender})},buildItems:function(){return[{xtype:"image",bind:{src:"{image}"},cls:"vv-login-img"},{xtype:"form",reference:"form",cls:"vv-login-form",bodyCls:"vv-login-form-body",defaults:{width:"100%",labelAlign:"top",labelSeparator:""},items:[{xtype:"textfield",cls:"vv-login-user",msgTarget:"under",labelClsExtra:"vv-login-user-lbl",fieldLabel:Valence.lang.lit.userName,allowBlank:false,name:"user",itemId:"user",reference:"user",ui:"large",bind:{value:"{username}"},triggers:{user:{cls:"login-trigger vvicon-user vv-login-user-trigger"}}},{xtype:"textfield",cls:"vv-login-pwd",msgTarget:"under",labelClsExtra:"vv-login-pwd-lbl",name:"password",itemId:"password",reference:"password",validateOnBlur:false,ui:"large",fieldLabel:Valence.lang.lit.password,allowBlank:false,inputType:"password",bind:{hidden:"{forgotPasswordPrompt}",disabled:"{forgotPasswordPrompt}",value:"{password}"},triggers:{lock:{cls:"login-trigger vvicon-lock vv-login-user-password"}},listeners:{specialkey:"onSpecialKeyPassword"}},{xtype:"button",formBind:true,cls:"vv-login-btn",itemId:"login-btn",bind:{hidden:"{forgotPasswordPrompt}"},text:Valence.lang.lit.login,scale:"medium",handler:"onLogin"},{xtype:"button",formBind:true,cls:"vv-login-sendpwd-btn",itemId:"sendpwd-btn",bind:{hidden:"{!forgotPasswordPrompt}"},text:Valence.lang.lit.sendPassword,scale:"medium",handler:"onSendPassword"},{xtype:"component",cls:"vv-login-forgotpwd-cancel",html:Valence.lang.lit.cancel,bind:{hidden:"{!forgotPasswordPrompt}"},listeners:{el:{click:"onClickCancelForgotPassword"}}},{xtype:"component",cls:"vv-login-select-lng",itemId:"selectlng-btn",hidden:!Valence.login.config.Settings.getMultiLingual(),html:Valence.lang.lit.selectLanguage,listeners:{el:{click:"onClickSelectLanguage"}}}]},{xtype:"component",cls:"vv-login-forgot-pwd",itemId:"forgotpwd-btn",bind:{hidden:"{!forgotPassword}",html:"{forgotPasswordText}"},listeners:{el:{click:"onClickForgotPassword"}}}]},onAfterRender:function(b){var a=this;Ext.on("resize",a.onResizeBrowser,a)},onDestroy:function(){var a=this;Ext.un("resize",a.onResizeBrowser,a);a.callParent(arguments)},onResizeBrowser:function(){var a=this;a.updateLayout()}});Ext.define("Valence.login.Processor",{singleton:true,requires:["Valence.util.Helper","Valence.common.util.Helper","Valence.locale.en","Valence.login.AppUmbrella","Valence.login.config.Runtime","Valence.login.config.Settings","Valence.login.store.Languages","Valence.login.util.Helper","Valence.login.store.Connections","Valence.login.store.Login_Environments","Valence.login.view.login.Login"],config:{appId:null,appUmbrella:null,autoLogout:null,bypassLogin:false,bypassReuseSid:false,callback:null,connectionName:null,customSid:"",forcePrompt:false,forgotPassword:true,hook:"",hostUrl:"",image:null,isRunningInPortal:false,language:"",namespace:"",mode:"desktop",options:{},password:null,renderTo:null,scope:null,sid:null,theme:"",themePath:null,username:"",version:null},scripts:[],applyMode:function(a){Valence.login.config.Runtime.setIsDesktop(a==="desktop");Valence.login.config.Runtime.setIsMobile(a!=="desktop");return a},applyNamespace:function(a){Valence.login.config.Runtime.setNamespace(a);return a},applyOptions:function(b){var a=this;a.setBypassLogin(false);if(b.callback){a.setCallback(b.callback)}if(!Ext.isEmpty(b.forgotPassword)){a.setForgotPassword(b.forgotPassword)}if(b.hook){a.setHook(b.hook)}a.setImage(b.image||"/resources/images/valence_logo.png");if(b.mode){a.setMode(b.mode)}if(b.namespace){a.setNamespace(b.namespace)}if(b.scope){a.setScope(b.scope)}if(b.username){a.setUsername(b.username)}if(Ext.isEmpty(b.hostUrl)){b.hostUrl=window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}a.setHostUrl(b.hostUrl);if(b.version){a.setVersion(b.version)}if(b.connectionName){a.setConnectionName(b.connectionName)}if(b.renderTo){a.setRenderTo(b.renderTo)}else{a.setRenderTo((Ext.isModern)?Ext.Viewport.el:Ext.getBody())}if(b.themePath){a.setThemePath(b.themePath)}return b},checkHookForImage:function(){var a=this,c=(!Ext.isEmpty(Valence)&&!Ext.isEmpty(Valence.Hook))?Valence.Hook:null,b;if(!Ext.isEmpty(c)&&!Ext.isEmpty(c.ui)&&!Ext.isEmpty(c.ui.loginLogoUrl)){var d=a.getTheme(),b=c.ui.loginLogoUrl;if(b){if(!Ext.isEmpty(b[d])){b=b[d]}else{b=b["default"]}}}if(!Ext.isEmpty(b)){a.setImage(b)}},createUUID:function(){var c=[],a="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(var b=0;b<32;b++){c[b]=a.substr(Math.floor(Math.random()*62),1)}c[14]="4";c[19]=a.substr((c[19]&3)|8,1);return c.join("")},init:function(b){var a=this;Ext.applyIf(b,{scope:a,mode:"desktop",poll:true,autoLock:true,autoLogout:true,manageIframes:false});a.setOptions(b);a.processUrl().then(a.processConnections).then(a.processHook).then(a.processSid).then(a.processToken).then(a.processSettings).then(a.processLanguage).then(a.processLocale).then(a.processTheme).then(a.processFavicon).then(a.processAppUmbrella).then(a.processView).then(a.processLoginData).then(a.processUnload).then(a.processCallback).then(a.processAppTasks).then(null,a.processFailure)},isPortal:function(){return Valence.login.config.Runtime.getNamespace()==="Portal"},processAppTasks:function(d){var c=d.scope,b=Ext.create("Ext.Deferred"),a=c.getAppUmbrella();a.initTasks();b.resolve(d);return b.promise},processAppUmbrella:function(d){var c=d.scope,a=Ext.create("Ext.Deferred"),b=c.getOptions();c.setAppUmbrella(Ext.create("Valence.login.AppUmbrella"));c.getAppUmbrella().init(b);a.resolve(d);return a.promise},processCallback:function(e){var d=e.scope,b=Ext.create("Ext.Deferred"),a=d.getCallback(),c=d.getScope()||e.scope;if(a){if(Ext.isModern){Ext.Viewport.unmask()}Ext.callback(a,c)}b.resolve(e);return b.promise},processConnections:function(h){var i=h.scope,l=Ext.create("Ext.Deferred"),g,d,k,j,e,a,b,f,c;if(i.getNamespace()=="Portal"&&Ext.isModern&&(Ext.os.name=="iOS"||Ext.os.name=="Android")){c=function(n,m,o){if(!o||k.getCount()==0){Ext.Viewport.unmask();g={xtype:"connection",fullScreen:true,viewModel:{data:{inConnectionEditMode:false}},listeners:{connectionadded:function(p,q){e=q.url+":"+q.port;Ext.Ajax.request({url:e+"/valence/vvlogin.pgm",params:{action:"getSettings"},success:function(){p.destroy();k.add(q);k.sync();Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading});l.resolve(h);i.setOptions(Ext.apply(i.getOptions(),{hostUrl:e}));i.setHostUrl(e)},failure:function(){Valence.common.util.Dialog.show({title:Valence.lang.lit.invalidConnection,msg:"Cannot connect to "+q.desc,buttons:["->",{text:Valence.lang.lit.ok}]})}})},connectionfromlink:function(){d=k.findRecord("selected",true);if(Ext.isEmpty(d)&&k.getCount()>0){d=k.getAt(0);d.set("selected",true);d.commit();k.sync()}e=d.get("url")+":"+d.get("port");i.setOptions(Ext.apply(i.getOptions(),{hostUrl:e}));i.setHostUrl(e);j.destroy();Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading});l.resolve(h)},scope:i}};j=Ext.Viewport.add(g)}else{d=k.findRecord("selected",true);if(Ext.isEmpty(d)){d=k.getAt(0);d.set("selected",true);d.commit();k.sync()}f=d.get("desc");Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:"Checking "+f});e=d.get("url")+":"+d.get("port");i.setHostUrl(e);i.setOptions(Ext.apply(i.getOptions(),{hostUrl:e}));Ext.Ajax.request({url:e+"/valence/vvlogin.pgm",params:{action:"getSettings"},success:function(){Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading});l.resolve(h)},failure:function(){i.setHostUrl("");d.set("invalid",true);d.commit();k.sync();Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading});l.resolve(h)}})}};Valence.login.config.Settings.setLockConnections(localStorage.getItem("vvlocked")=="true");Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading});k=Ext.getStore("Connections");if(Ext.isEmpty(k)){k=Ext.create("Valence.login.store.Connections")}if(!k.isLoaded()){k.load({callback:function(n,m,o){c(n,m,o)}})}else{c(null,null,true)}}else{l.resolve(h)}return l.promise},processFailure:function(d){var c=d.scope,a=c.getCallback(),b=c.getScope()||d.scope;if(d.processLocale){c.processLocale(d)}if(d.processTheme){c.processTheme(d)}if(d.executeCallback){if(a){Ext.callback(a,b)}}if(!d.controlledError){Ext.log({msg:'Error occurred during login "Processor"'})}},processFavicon:function(d){var c=d.scope,a=Ext.create("Ext.Deferred"),b=document.createElement("link");b.type="image/x-icon";b.rel="shortcut icon";b.href=Valence.login.config.Settings.getFavicon();document.getElementsByTagName("head")[0].appendChild(b);a.resolve(d);return a.promise},processHook:function(d){var c=d.scope,a=Ext.create("Ext.Deferred"),b=new Date().getTime(),e=c.getHook();if(e){if(e.search("?")===-1){e+="?"}else{e+="&"}e+="_vc="+b;e=c.getHostUrl()+e;c.scripts.push(e)}else{if(Valence.login.config.Runtime.getIsDesktop()){e=c.getHostUrl()+"/resources/desktop/Hook.js?_vc="+b;c.scripts.push(e)}}if(c.scripts.length>0){Valence.util.Helper.execScriptFiles({urls:c.scripts,callback:function(){a.resolve(d)}})}else{a.resolve(d)}return a.promise},processLanguage:function(c){var b=c.scope,a=Ext.create("Ext.Deferred"),d=Valence.login.config.Settings.getMultiLingual(),e;if(d){e=Ext.create("Valence.login.store.Languages");e.getProxy().setUrl(b.getHostUrl()+"/valence/vvlogin.pgm");e.load()}a.resolve(c);return a.promise},processLocale:function(c){var b=c.scope,a=Ext.create("Ext.Deferred"),d=b.getLanguage();if(Ext.isEmpty(d)){d=Valence.login.config.Settings.getDefaultLanguage()}b.setLanguage(d);Valence.login.config.Runtime.setLanguage(d);if(!Ext.isEmpty(d)&&d!=="en"){Valence.lang.loadLanguage(d);b.scripts.push(b.getHostUrl()+"/extjs/build/classic/locale/locale-"+d+".js");Valence.util.Helper.execScriptFiles({urls:b.scripts,callback:function(){b.scripts.length=0;a.resolve(c)}})}else{a.resolve(c)}return a.promise},processLock:function(){var c=this,a,b;Ext.suspendLayouts();a={xtype:"lock",fullScreen:true,viewModel:{data:{connectionName:c.getConnectionName(),hostUrl:c.getHostUrl(),lockText:{text:Valence.lang.lit.sessionLockedForUser+" "+Valence.login.config.Runtime.getUser()},namespace:c.getNamespace(),mode:c.getMode(),version:c.getVersion()}},listeners:{unlocked:function(){b.destroy()}}};if(!Ext.isModern){a.renderTo=c.getRenderTo();b=Ext.widget("lock",a)}else{b=Ext.Viewport.add(a)}setTimeout(function(){Ext.resumeLayouts(true)},200)},processLoginData:function(c){var b=c.scope,a=Ext.create("Ext.Deferred");Valence.login.config.Runtime.setLoginData(c);a.resolve(c);return a.promise},processSettings:function(c){var b=c.scope,a=Ext.create("Ext.Deferred"),d=Valence.login.config.Runtime.getApplication();Ext.Ajax.request({url:b.getHostUrl()+"/valence/vvlogin.pgm",params:{action:"getSettings",mode:b.getMode(),customSid:b.getCustomSid(),forcePrompt:b.getForcePrompt()},success:function(f){var h=Ext.decode(f.responseText),e=Valence.login.config.Settings;e.setBrowserTitle(Valence.util.Helper.decodeUTF16(h.browserTitle));e.setDateFormat(h.dateFormat);e.setDefaultLanguage(h.defaultLanguage);e.setIconOnTab(h.iconOnTab);e.setLockTimeout(h.lockTimeout);e.setLogoutOnUnload(h.logoutOnUnload);e.setSessionTimeout(h.sessTimeout);e.setMaxAppsOpen(h.maxAppsOpen);e.setMaxAutoStartApps(h.maxAutoStart);e.setMenuTextMode(h.usrEnvMode);e.setMultiLingual(h.multilingual);e.setPasswordReset(h.pwdResetAllowed);e.setPathVariables(h.pathVar);e.setPollInterval(h.pollInterval);e.setSetUserCookie(h.usrCookie);e.setWelcomePage(h.welcomePage);e.setVersion(h.version);if(!b.getVersion()){b.setVersion(h.version)}if(b.isPortal()&&h.browserTitle){document.title=Valence.util.Helper.decodeUTF16(h.browserTitle)}if(d){d.fireEvent("settingsapplied",h)}if(h.sid){b.setBypassLogin(true);if(h.loginId){h.loginId=Valence.util.Helper.decodeUTF16(h.loginId);Valence.login.config.Runtime.setUser(h.loginId);h.firstname=Valence.util.Helper.decodeUTF16(h.firstname);h.lastname=Valence.util.Helper.decodeUTF16(h.lastname)}if(h.envs){Ext.create("Valence.login.store.Login_Environments",{data:h.envs})}if(h.env){sessionStorage.setItem("env",h.env);if(d){d.fireEvent("environmentset",h.loginId,h.env)}}if(h.vvRmtCall){var g=Valence.login.config.Runtime.getUrlParms();Ext.apply(g,h.vvRmtCall)}Ext.apply(c,h)}a.resolve(c)},failure:function(){Ext.log({msg:"Valence login processor: call to getSettings failure"});if(Ext.os.name=="iOS"||Ext.os.name=="Android"){a.resolve(c)}else{a.reject()}}});return a.promise},processSid:function(d){var c=d.scope,b=Ext.create("Ext.Deferred"),a=c.getSid(),g=Valence.login.config.Runtime.getApplication(),e;if(!c.isPortal()){e=Ext.getUrlParam("app");if(!Ext.isEmpty(e)){c.setAppId(e)}}if(Ext.isEmpty(a)||c.getBypassReuseSid()){b.resolve(d)}else{var f={action:"isValidSession"};if(!Ext.isEmpty(e)){Ext.apply(f,{validateAppId:e})}Ext.Ajax.request({url:c.getHostUrl()+"/valence/vvlogin.pgm",params:f,scope:c,success:function(h){var j=Ext.decode(h.responseText);if(j.success){j.loginId=Valence.util.Helper.decodeUTF16(j.loginId);Ext.create("Valence.login.store.Login_Environments",{data:j.envs});if(!Ext.isEmpty(j.env)){if(Valence.login.config.Runtime.getIsDesktop()){sessionStorage.setItem("env",j.env)}if(g){g.fireEvent("environmentset",j.loginId,j.env)}var i=Ext.getStore("Login_Environments").findRecord("envId",j.env,0,false,true,true);if(i){i.set("current",true);i.commit()}}c.setBypassLogin(j.success);Valence.login.config.Runtime.setUser(j.loginId);j.firstname=Valence.util.Helper.decodeUTF16(j.firstname);j.lastname=Valence.util.Helper.decodeUTF16(j.lastname);sessionStorage.setItem("sid",j.sid);b.resolve(Ext.apply(d,j,{reuseSid:true,sid:a}))}else{if(!Ext.isEmpty(j.lit)){Valence.login.util.Helper.showImageDialog(Valence.common.util.Helper.getLit(j),c.getImage());b.reject()}else{b.resolve(Ext.apply(d,j,{reuseSid:false,sid:null}));localStorage.removeItem("sid");sessionStorage.removeItem("sid")}}},failure:function(){Ext.log({msg:"Valence login processor: call to isValidSession failure"});if(c.getNamespace()=="Portal"&&Ext.isModern&&(Ext.os.name=="iOS"||Ext.os.name=="Android")){localStorage.removeItem("sid");sessionStorage.removeItem("sid");b.resolve(d)}else{Valence.login.util.Helper.showImageDialog(Valence.lang.lit.noResponseFromServer,c.getImage())}}})}return b.promise},processTasks:function(){var a=this},processTheme:function(d){var e=d.scope,h=Ext.create("Ext.Deferred"),b=e.getTheme()||localStorage.getItem("valence-theme")||"default",c=e.getMode(),a=new Date().getTime(),i;if(b){if(e.isPortal()){i="/resources/"+c+"/themes/css/Portal/"+b+".css"}else{if(e.getThemePath()){i=e.getThemePath()+b+".css"}else{i=(!Ext.isEmpty(Ext.isClassic)&&Ext.isClassic)?"resources/themes/classic/":"resources/themes/modern/";i+=b+".css"}}if(!Valence.login.config.Runtime.getIsDesktop()){b=e.getHostUrl()+b}var g=document.head,f=document.createElement("link");f.id="portaltheme";f.type="text/css";f.rel="stylesheet";f.href=i;g.appendChild(f);e.setTheme(b);localStorage.setItem("valence-theme",b);f=document.createElement("link");f.id="portaloverrides";f.type="text/css";f.rel="stylesheet";f.href="/resources/"+c+"/themes/css/Portal/overrides.css?_vc="+a;g.appendChild(f);if(!e.isPortal()){Valence.util.Helper.addEventListener("themechanged",Valence.util.Helper.swapTheme)}}h.resolve(d);return h.promise},processToken:function(d){var c=d.scope,a=Ext.create("Ext.Deferred");if(!Ext.isModern){if(Ext.util.Cookies.get("vvtoken")===null){var b=c.createUUID(),e=location.protocol==="https:"?true:false;Ext.util.Cookies.set("vvtoken",b,null,"/",null,e)}}a.resolve(d);return a.promise},processUnload:function(c){var b=c.scope,a=Ext.create("Ext.Deferred"),d=(!Ext.isEmpty(b.getAutoLogout()))?b.getAutoLogout():Valence.login.config.Settings.getLogoutOnUnload();if(d){window.onunload=function(){var g=Valence.login.config.Runtime.getApplication();if(g){g.fireEvent("logout")}else{var f=Ext.ComponentQuery.query("uxiframe[app]");for(var e=0;e<f.length;e++){f[e].destroy()}if(!Ext.isEmpty(Valence.login.config.Runtime.getUser())&&!Valence.login.config.Runtime.getIsLoggingOut()){var g=Valence.login.config.Runtime.getApplication();if(g){g.fireEvent("suspendpolling")}Ext.Ajax.request({url:b.getHostUrl()+"/valence/vvvport.pgm",params:{action:"logout"},async:false})}}};window.onbeforeunload=function(e){if(!Valence.login.config.Runtime.getIsLoggingOut()&&Valence.login.config.Runtime.getUser()&&Valence.login.config.Runtime.getUrlParms().portal!=="false"){return Valence.lang.lit.valencePortal}}}a.resolve(c);return a.promise},processUrl:function(){var d=this,b=Ext.create("Ext.Deferred"),c=Valence.login.config.Runtime.getUrlParms(),a=(!Ext.isEmpty(c.sid))?c.sid:localStorage.getItem("sid");d.setCustomSid(!Ext.isEmpty(c.customSid)?c.customSid:"");d.setForcePrompt(!Ext.isEmpty(c.forcePrompt)?c.forcePrompt:false);d.setLanguage(!Ext.isEmpty(c.lang)?c.lang:"");d.setIsRunningInPortal(!Ext.isEmpty(c.sid)?true:false);d.setSid(a);if(c.hook){d.setHook(c.hook)}if(c.theme){d.setTheme(c.theme)}if(c.user){d.setUsername(c.user)}if(c.password){d.setPassword(c.password)}if(c.autoLogout){d.setAutoLogout((c.autoLogout==="true"))}if(d.getIsRunningInPortal()){b.reject({scope:d,executeCallback:true,processLocale:true,processTheme:true,controlledError:true})}if(!Ext.isEmpty(d.getCustomSid())){d.setBypassReuseSid(true)}b.resolve({scope:d,theme:c.theme||null});return b.promise},processView:function(e){var d=e.scope,b=Ext.create("Ext.Deferred"),a,c,f;if(d.getBypassLogin()){b.resolve(e)}else{d.checkHookForImage();if(!Ext.isEmpty(d.getUsername())&&!Ext.isEmpty(d.getPassword())){Valence.common.util.Helper.loadMask()}Ext.suspendLayouts();a={xtype:"login",fullScreen:true,viewModel:{data:{connectionName:d.getConnectionName(),hostUrl:d.getHostUrl(),image:d.getImage(),forgotPassword:d.getForgotPassword(),language:d.getLanguage(),namespace:d.getNamespace(),password:d.getPassword(),mode:d.getMode(),mobilePortal:d.getNamespace()=="Portal"&&Ext.isModern&&(Ext.os.name=="iOS"||Ext.os.name=="Android"),username:d.getUsername(),version:d.getVersion()}},listeners:{loggedin:function(g,i){g.destroy();if(Valence.login.config.Settings.getSetUserCookie()){localStorage.setItem("lastLoginUser",i.loginId||"")}if(!Ext.isEmpty(i.env)){var h=Ext.getStore("Login_Environments").findRecord("envId",i.env,0,false,true,true);if(h){h.set("current",true);h.commit()}}if(Ext.isModern){if(d.isPortal()){d.setOptions(Ext.apply(d.getOptions(),{hostUrl:d.getHostUrl()}))}Ext.Viewport.mask({indicator:true,xtype:"loadmask",message:Valence.lang.lit.loading})}b.resolve(Ext.apply(e,i))}}};if(!Ext.isModern){a.renderTo=d.getRenderTo();c=Ext.widget("login",a)}else{c=Ext.Viewport.add(a);setTimeout(function(){Ext.Viewport.unmask();if(!Ext.isEmpty(navigator.splashscreen)){navigator.splashscreen.hide()}},300)}setTimeout(function(){Ext.resumeLayouts(true)},500)}return b.promise}});Ext.define("Valence.login.view.changeenvironment.ChangeEnvironment",{extend:"Ext.window.Window",requires:["Ext.grid.Panel","Ext.layout.container.VBox","Valence.common.ux.grid.Renderer"],xtype:"changeenvironment",basePortal:true,cls:"vv-chgenv",closeAppsMsg:false,initComponent:function(){var a=this;Ext.apply(a,{layout:{type:"vbox",align:"stretch"},title:Valence.lang.lit.changeEnvironment,maxHeight:450,width:550,modal:true,items:a.buildItems(),buttons:a.buildButtons()});a.callParent(arguments)},buildButtons:function(){var a=this;return[{text:Valence.lang.lit.cancel,scope:a,handler:a.onEsc}]},buildItems:function(){var b=this,a=[];a.push({xtype:"grid",flex:1,cls:"vv-chgenv-list",bubbleEvents:["beforeitemclick","itemclick"],store:Ext.getStore("Login_Environments"),enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,columns:[{text:Valence.lang.lit.environment,menuDisabled:true,dataIndex:"envName",flex:1},{menuDisabled:true,dataIndex:"current",width:100,align:"center",renderer:Valence.common.ux.grid.Renderer.tick}]});if(b.closeAppsMsg){a.push({xtype:"component",cls:"vv-chgenv-appclose-msg",html:Valence.lang.lit.allRunningAppsClose})}return a}});Ext.define("Valence.login.view.lock.Lock",{extend:"Ext.container.Container",requires:["Ext.button.Button","Ext.form.Panel","Ext.form.field.Text","Ext.Img","Ext.layout.container.VBox","Valence.login.view.login.LoginModel","Valence.login.view.login.LoginController"],xtype:"lock",viewModel:{type:"login"},controller:"login",cls:"vv-lock-cnt",layout:{type:"vbox",align:"middle"},basePortal:true,initComponent:function(){var a=this;Ext.apply(a,{items:a.buildItems()});a.callParent(arguments)},buildItems:function(){return[{xtype:"image",src:Valence.login.util.Helper.getHookValue("ui.lockLogoUrl")||"/resources/images/valence_logo.png",cls:"vv-lock-img"},{xtype:"form",reference:"form",cls:"vv-lock-form depth-1",bodyCls:"vv-lock-form-body",defaults:{width:"100%",labelAlign:"top",labelSeparator:""},items:[{xtype:"textfield",cls:"vv-lock-pwd",labelClsExtra:"vv-lock-pwd-lbl",name:"password",reference:"password",msgTarget:"under",fieldLabel:Valence.lang.lit.password,allowBlank:false,inputType:"password",ui:"large",triggers:{lock:{cls:"login-trigger vvicon-lock vv-lock-user-password"}},listeners:{specialkey:"onSpecialKeyPassword"}},{xtype:"button",formBind:true,cls:"vv-login-btn",text:Valence.lang.lit.ok,scale:"medium",handler:"onUnlock"}]},{xtype:"component",tpl:['<div class="vv-lock-text">{[fm.uppercase(values.text)]}</div>'],bind:{data:"{lockText}"}}]}});